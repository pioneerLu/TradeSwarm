# TradeSwarm 自治多时间尺度系统设计文档

> 本文档面向开发人员，描述当前实现状态与未来规划。

---

## 1. 设计目标

TradeSwarm 是一个可**连续自治运行数周**、具备**多智能体协作能力**、拥有**长期记忆与自我稳定机制**的实验性研究框架。

---

## 2. 架构设计

### 2.1 当前实现

**执行流程**：

```text
┌─────────┐
│  开始   │
└────┬────┘
     │
     ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────────┐     ┌───────────────────────┐
│ Market Summary  │ --> │  News Summary   │ --> │ Sentiment Summary   │ --> │ Fundamentals Summary  │
└────────┬────────┘     └────────┬────────┘     └──────────┬──────────┘     └───────────┬───────────┘
         │                       │                          │                              │
         └───────────────────────┴──────────────────────────┴──────────────────────────────┘
                                                              │
                                                              ▼
                                                    ┌──────────────────────┐
                                                    │  Research Subgraph   │
                                                    │  (Bull/Bear 辩论)    │
                                                    └───────────┬──────────┘
                                                                │
                                                                ▼
                                                    ┌──────────────────┐
                                                    │ Research Manager │
                                                    └─────────┬────────┘
                                                              │
                                                              ▼
                                                    ┌───────────────┐
                                                    │ Trader Node   │
                                                    └───────┬───────┘
                                                             │
                                                             ▼
                                                    ┌──────────────────┐
                                                    │  Risk Subgraph   │
                                                    │  (Risky/Neutral/ │
                                                    │  Conservative)   │
                                                    └─────────┬────────┘
                                                              │
                                                              ▼
                                                    ┌───────────────┐
                                                    │ Risk Manager  │
                                                    └───────┬───────┘
                                                            │
                                                            ▼
                                                    ┌───────────────┐
                                                    │     结束      │
                                                    └───────────────┘
```

**技术实现**：
- LangGraph 1.2.0 + LangChain
- SQLite (`memory.db`) + ChromaDB
- Tushare/AKShare 数据源
- 统一的 `AgentState` 状态管理

### 2.2 期望的架构

**核心设计**：开盘前分析 → 生成策略 → 开盘执行 → 盘中监控

**完整流程**：

```text
┌──────────────┐
│  系统启动    │
└──────┬───────┘
       │
       ▼
┌─────────────────────────────┐
│   Time Router (时间路由)    │
└───────┬─────────────────────┘
        │
        ├─────────────────────────────────────────────────────────────────────┐
        │                                                                     │
        ▼                                                                     ▼
┌───────────────────────┐                                        ┌───────────────────────┐
│ pre_open: 8:00-9:30   │                                        │ market_open: 9:30     │
│                        │                                        │                       │
│   分析模块             │                                        │  策略执行节点         │
│   ┌─────────────────┐ │                                        │  ┌──────────────────┐ │
│   │ Summary Nodes    │ │                                        │  │ 读取已生成策略    │ │
│   │ - Market         │ │                                        │  └────────┬─────────┘ │
│   │ - News           │ │                                        │           │           │
│   │ - Sentiment      │ │                                        │           ▼           │
│   │ - Fundamentals   │ │                                        │  ┌──────────────────┐ │
│   └────────┬─────────┘ │                                        │  │ 执行策略         │ │
│            │           │                                        │  │ (买入/卖出)      │ │
│            ▼           │                                        │  └────────┬─────────┘ │
│   ┌─────────────────┐ │                                        │           │           │
│   │ Research        │ │                                        │           ▼           │
│   │ Subgraph        │ │                                        │  ┌──────────────────┐ │
│   │ (Bull/Bear)     │ │                                        │  │ 记录结果到DB     │ │
│   └────────┬────────┘ │                                        │  └──────────────────┘ │
│            │           │                                        └───────────────────────┘
│            ▼           │
│   ┌─────────────────┐ │
│   │ Research        │ │
│   │ Manager         │ │
│   └────────┬────────┘ │
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ Trader Node     │ │
│   └────────┬────────┘ │
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ Risk Subgraph   │ │
│   │ (Risky/Neutral/ │ │
│   │  Conservative)  │ │
│   └────────┬────────┘ │
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ Risk Manager    │ │
│   └────────┬────────┘ │
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ 策略生成节点     │ │
│   └────────┬────────┘ │
│            │           │
│            ├───────────┤
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ 生成结构化策略  │ │
│   │ (JSON格式)      │ │
│   └────────┬────────┘ │
│            │           │
│            ▼           │
│   ┌─────────────────┐ │
│   │ 保存到memory.db │ │
│   │ (trading_       │ │
│   │  strategies表)  │ │
│   └─────────────────┘ │
└───────────────────────┘
        │
        │
        ├─────────────────────────────────────────────────────────────────────┐
        │                                                                     │
        ▼                                                                     ▼
┌───────────────────────┐                                        ┌───────────────────────┐
│ intraday: 9:30-15:00  │                                        │ post_close: 15:00+   │
│                        │                                        │                       │
│  策略监控节点          │                                        │  收盘复盘             │
│                        │                                        │                       │
│  ┌──────────────────┐  │                                        │  ┌──────────────────┐ │
│  │ 监控持仓状态     │  │                                        │  │ 统计当日表现     │ │
│  └────────┬─────────┘  │                                        │  └────────┬─────────┘ │
│           │            │                                        │           │           │
│           ▼            │                                        │           ▼           │
│  ┌──────────────────┐  │                                        │  ┌──────────────────┐ │
│  │ 触发止损/止盈    │  │                                        │  │ 更新策略历史     │ │
│  └──────────────────┘  │                                        │  └────────┬─────────┘ │
└───────────────────────┘                                        │           │           │
                                                                  │           ▼           │
                                                                  │  ┌──────────────────┐ │
                                                                  │  │      结束        │ │
                                                                  │  └──────────────────┘ │
                                                                  └───────────────────────┘
```

**关键设计点**：
- 分析模块：Summary → Research → Trader → Risk（Risk Manager 属于分析模块）
- 时间路由：`time_router` 节点 + `conditional_edge`，根据 `trading_session` 路由
- 策略持久化：策略生成后保存到 `memory.db`（`trading_strategies` 表），作为历史经验
- 状态扩展：`AgentState` 添加 `trading_session`、`trading_strategy`、`strategy_status` 等字段

---

## 3. 核心模块

### 3.1 Analyst（分析师）

**设计原则**：并行运行、无状态、只分析不决策

**已实现**：`market_analyst`、`news_analyst`、`sentiment_analyst`、`fundamentals_analyst`

**待完善**：未集成到主交易图（现在使用 Summary 节点直接查询数据库）

### 3.2 Memory 系统

**已实现**：
- SQLite：`analyst_reports` 表，`MemoryDBHelper` 工具类
- ChromaDB：`FinancialSituationMemory` 向量记忆

**未实现**：Memory Controller（LLM 聚合历史报告生成摘要）

### 3.3 Manager（管理器）

- **Research Manager**：输入四个 Analyst 摘要 + 辩论，输出 `investment_plan`
- **Risk Manager**：输入 Research Plan + 风险辩论，输出 `final_trade_decision`（属于分析模块）
- **Trader**：输入 Research Plan，输出 `trader_investment_plan`

---

## 4. 多时间尺度设计

| 时间尺度 | 频率 | 主要信息 | 作用 |
|---------|------|---------|------|
| Intraday | 秒/分 | 盘口、价格、成交量 | 快速响应、风险控制 |
| Daily | 日（收盘后） | 行情汇总、新闻、公告 | 形成阶段性判断 |
| Slow | 周/月 | 宏观、结构性信息 | 稳定长期信念 |

**权限原则**：
- 盘中：不允许修改长期 belief，不写入长期 memory
- 收盘后：允许写入 analyst memory，触发融合与研究推理
- 低频：进行 memory consolidation，更新长期信念

---

## TODO

### 结构相关

- [ ] **conditional_edge**：实现 `time_router` 节点 + `conditional_edge`，可能要修改 `AgentState`
- [ ] **策略生成节点**：整合 Research/Risk Manager 输出，生成结构化策略（JSON），保存到 `trading_strategies` 表
- [ ] **策略执行节点**：开盘时执行策略，盘中监控（止损/止盈），记录执行结果
- [ ] **Memory Controller**：实现 `MemoryController` 接口，LLM 聚合历史报告生成摘要
- [ ] **集成 Analyst 节点到主图**：替代 Summary 节点直接查询，实现并行执行
- [ ] **子图执行**：改成并行（待定）
- [ ] 
### prompt/node优化

- [ ] **Fusion Layer**：LLM 聚合多 Analyst 观点
- [ ] **Factor Layer**：因子计算模块，提取因子状态
- [ ] **Memory Consolidation**：合并相似结论，提炼长期 belief


### 交易平台相关

- [ ] **交易执行接口**：集成券商 API 或模拟交易
- [ ] **系统级反馈**：决策结果反向修正 memory 权重
- [ ] **策略回测集成**：Backtrader/VectorBT 集成
- [ ] **监控与日志**：系统监控面板、性能指标收集

---
